<VirtualHost *:80>
    ServerName <%= @params[:server_name] %>
    ServerAlias <% @params[:server_aliases].each do |a| %><%= a %> <% end %>
    DocumentRoot <%= @params[:docroot] %>

    RailsBaseURI /
    RailsEnv <%= @rails_env %>


    PassengerMinInstances <%= @params[:extra][:PassengerMinInstances].to_i %>
    PassengerMaxPoolSize <%= @params[:extra][:PassengerMaxPoolSize].to_i %>
    PassengerPoolIdleTime <%= @params[:extra][:PassengerPoolIdleTime].to_i %>
    PassengerMaxInstancesPerApp <%= @params[:extra][:MaxInstancesPerApp].to_i %>
    PassengerMaxPreloaderIdleTime <%= @params[:extra][:MaxPreloaderIdleTime].to_i %>
    PassengerHighPerformance <%= @params[:extra][:PassengerHighPerformance] %>
    PassengerBufferUpload <%= @params[:extra][:PassengerBufferUpload] %>
    PassengerBufferResponse <%= @params[:extra][:PassengerBufferResponse] %>

    #SetEnv ELASTICSEARCH_URL

    <Directory <%= @params[:docroot] %>>
        Options FollowSymLinks -MultiViews
        AllowOverride None
        Order allow,deny
        Allow from all
    </Directory>

    ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
    CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined

    RewriteEngine Off
    RewriteLog <%= node['apache']['log_dir'] %>/<%= @application_name %>-rewrite.log
    RewriteLogLevel 0
    # Canonical host
    RewriteCond %{HTTP_HOST}   !^<%= @params[:server_name] %> [NC]
    RewriteCond %{HTTP_HOST}   !^$
    RewriteRule ^/(.*)$        http://<%= @params[:server_name] %>/$1 [L,R=301]

    RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
    RewriteCond %{SCRIPT_FILENAME} !maintenance.html
    RewriteRule ^.*$ /system/maintenance.html [L]
</VirtualHost>

PassengerPreStart http://<%= @params[:server_name] %>
